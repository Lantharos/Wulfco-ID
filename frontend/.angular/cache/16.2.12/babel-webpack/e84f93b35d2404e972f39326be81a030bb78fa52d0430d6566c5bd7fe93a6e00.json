{"ast":null,"code":"import _asyncToGenerator from \"D:/Wulfco/Wulfco ID 2/frontend-angular/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { config } from \"../config\";\nclass KeyManagment {\n  base64SpkiToUint8Array(base64Spki) {\n    const binaryStr = atob(base64Spki);\n    const bytes = new Uint8Array(binaryStr.length);\n    for (let i = 0; i < binaryStr.length; i++) {\n      bytes[i] = binaryStr.charCodeAt(i);\n    }\n    return bytes;\n  }\n  fetchPublicKey() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      const response = yield fetch(config.api_url + \"/public-key\").catch(() => {\n        throw new Error(\"Failed to fetch public key\");\n      });\n      const base64Key = yield response.json();\n      // Assuming Base64-encoded ASN.1 DER format\n      const spkiKey = _this.base64SpkiToUint8Array(base64Key.publicKey); // (Implementation below)\n      return yield crypto.subtle.importKey(\"spki\", spkiKey, {\n        name: \"RSA-OAEP\",\n        hash: \"SHA-256\"\n      },\n      // Make sure this matches backend padding\n      false, [\"encrypt\"]);\n    })();\n  }\n}\nexport class AuthCrypto {\n  /*\n  * This function encrypts given data using the server's public key\n  * @input data: string\n  * @output string\n   */\n  PublicEncrypt(data) {\n    return _asyncToGenerator(function* () {\n      const KeyManager = new KeyManagment();\n      const publicKey = yield KeyManager.fetchPublicKey();\n      const encryptedData = yield crypto.subtle.encrypt({\n        name: \"RSA-OAEP\"\n      }, publicKey, new TextEncoder().encode(data));\n      return new Uint8Array(encryptedData).toString();\n    })();\n  }\n  /*\n  * This function encrypts given data using AES\n  * @input data: string\n  * @input key: CryptoKey\n  * @input iv: Uint8Array\n  * @output string\n   */\n  AESEncrypt(data, key, iv) {\n    return _asyncToGenerator(function* () {\n      const encoder = new TextEncoder(); // For text conversions\n      const cipherText = yield crypto.subtle.encrypt({\n        name: \"AES-CBC\",\n        iv\n      }, key, encoder.encode(data));\n      return new Uint8Array(cipherText).toString();\n    })();\n  }\n  /*\n  * This function decrypts given data using AES\n  * @input data: Uint8Array\n  * @input key: CryptoKey\n  * @input iv: Uint8Array\n  * @output string\n   */\n  AESDecrypt(data, key, iv) {\n    return _asyncToGenerator(function* () {\n      const decryptedData = yield crypto.subtle.decrypt({\n        name: \"AES-CBC\",\n        iv\n      }, key, data);\n      return new TextDecoder().decode(decryptedData);\n    })();\n  }\n  /*\n  * This function generates a new AES key\n  * @output CryptoKey\n  * @output iv: Uint8Array\n  * @output string\n   */\n  GenerateAESKey() {\n    return _asyncToGenerator(function* () {\n      return yield crypto.subtle.generateKey({\n        name: \"AES-CBC\",\n        length: 256\n      },\n      // 256-bit key\n      true,\n      // extractable\n      [\"encrypt\", \"decrypt\"] // key usages\n      );\n    })();\n  }\n  /*\n  * This function encrypts given data using AES and then encrypts the symmetric key using the server's public key\n  * @input data: string\n  * @output {encryptedData: string, encryptedSymmetricKey: string, iv: string}\n   */\n  SimpleEncrypt(data) {\n    return _asyncToGenerator(function* () {\n      const KeyManager = new KeyManagment();\n      const symmetricKey = yield crypto.subtle.generateKey({\n        name: \"AES-CBC\",\n        length: 256\n      },\n      // 256-bit key\n      true,\n      // extractable\n      [\"encrypt\", \"decrypt\"] // key usages\n      );\n\n      const iv = crypto.getRandomValues(new Uint8Array(16)); // 16 bytes for AES-CBC\n      const encoder = new TextEncoder(); // For text conversions\n      const cipherText = yield crypto.subtle.encrypt({\n        name: \"AES-CBC\",\n        iv\n      }, symmetricKey, encoder.encode(data));\n      const publicKey = yield KeyManager.fetchPublicKey().catch(() => {\n        throw new Error(\"Failed to fetch public key\");\n      });\n      const encryptedKey = yield crypto.subtle.encrypt({\n        name: \"RSA-OAEP\"\n      }, publicKey, new Uint8Array(yield crypto.subtle.exportKey(\"raw\", symmetricKey)) // Export symmetric key as raw bytes\n      );\n\n      return {\n        encryptedData: new Uint8Array(cipherText).toString(),\n        encryptedSymmetricKey: new Uint8Array(encryptedKey).toString(),\n        iv: new Uint8Array(iv).toString()\n      };\n    })();\n  }\n  Hash(data) {\n    return _asyncToGenerator(function* () {\n      const digest = yield crypto.subtle.digest(\"SHA-256\", new TextEncoder().encode(data));\n      return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join(''); // Convert to hex\n    })();\n  }\n\n  KDF(data) {\n    return _asyncToGenerator(function* () {\n      return yield crypto.subtle.importKey(\"raw\", new TextEncoder().encode(data), {\n        name: \"PBKDF2\"\n      }, false, [\"deriveKey\"]);\n    })();\n  }\n}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}